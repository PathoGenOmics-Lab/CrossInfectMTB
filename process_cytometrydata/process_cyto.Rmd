---
title: "Cytometry Analysis"
author: "Paula Ruiz Rodriguez"
date: today
date-format: "DD/MM/YYYY"
format:
  html: 
    code-fold: true
    page-layout: article
    embed-resources: true
    smooth-scroll: true
    theme: minty
    toc: true
    toc-depth: 5
    toc-location: left
    toc-title: Summary
    number-sections: true
    grid:
      sidebar-width: 200px
      body-width: 1200px
      margin-width: 100px
      gutter-width: 1.5rem  
editor: visual
---
```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```
```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r libraries, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(mycolorsTB)
library(tidyr)
library(plotly)
library(DT)
library(MASS)
library(ggfortify)
library("FactoMineR")
library("factoextra")
library(cluster)
library(corrplot)
library(ggpattern)
library(bbplot)
library(ggpubr)
library(plotly)
```

```{r load_data, message=FALSE, warning=FALSE, echo=FALSE}
raw_data <- read.table("raw3.txt", sep = "\t", dec = ",", header = TRUE)
```

# Controls
First, I analyze the controls for each experiment and cell type, summarizing their count (N), mean, median, maximum, minimum, and standard deviation.
```{r stats_table, message=FALSE, warning=FALSE}
control_cols <- grep("Control", names(raw_data), value = TRUE)
control_data <- raw_data[c("Experiment", "Strain", "Day", "Cell", "Cell_Type",
                           control_cols)]
control_data_unique <- unique(control_data)

control_data_long <- control_data_unique %>%
  pivot_longer(cols = c(ControlAN1, ControlAN2, ControlAN3, ControlAN4,
                        ControlAN5, ControlAN6, ControlAN7, ControlAN8),
               names_to = "Control",
               values_to = "Value") %>%
  pivot_longer(cols = c(ControlAN1_ID, ControlAN2_ID, ControlAN3_ID,
                        ControlAN4_ID, ControlAN5_ID, ControlAN6_ID,
                        ControlAN7_ID, ControlAN8_ID),
               names_to = "Control_ID",
               values_to = "ID") %>%
  filter(sub("ControlAN", "", Control) == sub("ControlAN", "",
                                              sub("_ID", "", Control_ID)))
control_data_long$Control_ID <- NULL
stats <- na.omit(control_data_long)
estadisticos <- stats %>%
  group_by(Experiment, Strain, Day, Cell, Cell_Type) %>%
  summarise(
    N = n(),
    mean = mean(Value, na.rm = TRUE),
    median = median(Value, na.rm = TRUE),
    min = min(Value, na.rm = TRUE),
    max = max(Value, na.rm = TRUE),
    sd = sd(Value, na.rm = TRUE)
  )
datatable(estadisticos)
```
## Visualization of Controls 
To visualize the data, I plot ALL the controls, where each point represents a control, including replicates.
::::: {.panel-tabset}
# Split by Day
:::: {.panel-tabset}
## Day 2
```{r fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
# Calcular el numero de observaciones por grupo y encontrar el maximo valor de Value para cada grupo
filter_Day2 <- filter(control_data_long, Day == "D2")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = sum(!is.na(Value)), max_value = max(Value, na.rm = TRUE), .groups = 'drop')

boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = Value)) +
  geom_boxplot(aes(color = Strain), outlier.shape = NA) +  # Mover color a aes() para los boxplots
  geom_jitter(aes(shape = Experiment),
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() + 
  theme_bw() +
  labs(y = "", x = "", title = "Day 2") +
  scale_shape_manual(values = c(21, 24,25,22,18,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)
boxplotD2
```
## Day 6
```{r fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
# Calcular el número de observaciones por grupo y encontrar el máximo valor de Value para cada grupo
filter_Day2 <- filter(control_data_long, Day == "D6")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = sum(!is.na(Value)), max_value = max(Value, na.rm = TRUE), .groups = 'drop')

boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = Value)) +
  geom_boxplot(aes(color = Strain), outlier.shape = NA) +  # Mover color a aes() para los boxplots
  geom_jitter(aes(shape = Experiment), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +  # Escala de color para los puntos
  theme_bw() +
  labs(y = "", x = "", title = "Day 6") +
  scale_shape_manual(values = c(21, 24,25,22,18,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)
boxplotD2
```
::::
# Split by Day and Experiment
```{r funcexp,, message=FALSE, warning=FALSE, echo=FALSE }
create_boxplot <- function(data, experiment_id, day, shape_value) {
  # Define los valores requeridos para Strain, Cell y Cell_Type
  required_strains <- c("A4", "A1", "L5", "L6")
  required_cells <- c("BoMac", "THP1")
  required_cell_types <- c("Late Apoptosis", "Early Apoptosis", "Necrotic", "Live")

  # Filtra los datos basándose en el ID del experimento y el día
  filtered_data <- filter(data, Day == day, Experiment == experiment_id)

  # Asegura que todas las combinaciones de Strain, Cell y Cell_Type estén presentes
  filtered_data <- filtered_data %>%
    complete(Strain = required_strains, Cell = required_cells, Cell_Type = required_cell_types, 
             nesting(Experiment), fill = list(Value = NA))

  # Calcula conteos y valores máximos
  conteos <- filtered_data %>%
    group_by(Strain, Cell, Cell_Type) %>%
    summarize(N = sum(!is.na(Value)), max_value = max(Value, na.rm = TRUE), .groups = 'drop')

  # Crea el boxplot
  boxplot <- ggplot(filtered_data, aes(x = Strain, y = Value)) +
    geom_boxplot(aes(color = Strain), outlier.shape = NA) +
    geom_jitter(aes(shape = Experiment),
                position = position_jitter(width = 0.2),
                size = 2,
                alpha = 0.4) +
    facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") +
    scale_color_mycolors() +
    theme_bw() +
    labs(y = "", x = "", title = paste("Day", day)) +
    scale_shape_manual(values = shape_value) +
    theme(axis.title = element_text(size = rel(1.5)),
          axis.text = element_text(size = rel(1.2)),
          plot.title = element_text(size = rel(1.8)),
          strip.text = element_text(size = rel(1.2))) +
    geom_text(data = conteos, aes(label = N, y = max_value * 1.05),
              position = position_dodge(width = 0.75),
              size = 3, vjust = 0)

  return(boxplot)
}
```
:::: {.panel-tabset}
## EXP0002
::: {.panel-tabset}
### Day 2
```{r day2exp2,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "2", "D2", 22)
```
### Day 6 
```{r day6exp2,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "2", "D6", 22)
```
:::
## EXP0003
::: {.panel-tabset}
### Day 2
```{r day2exp3,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "3", "D2", 22)
```
### Day 6 
```{r day6exp3,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "3", "D6", 22)
```
:::
## EXP0004
::: {.panel-tabset}
### Day 6 
```{r day6exp4,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "4", "D6", 22)
```
:::
## EXP0005
::: {.panel-tabset}
### Day 2
```{r day2exp5,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "5", "D2", 22)
```
### Day 6 
```{r day6exp5,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "5", "D6", 22)
```
:::
## EXP0007
::: {.panel-tabset}
### Day 2
```{r day2exp7,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "7", "D2", 22)
```
### Day 6 
```{r day6exp7,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "7", "D6", 22)
```
:::
## EXP0009
::: {.panel-tabset}
### Day 2
```{r day2exp9,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "9", "D2", 22)
```
### Day 6 
```{r day6exp9,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "9", "D6", 22)
```
:::
## EXP0010
::: {.panel-tabset}
### Day 2
```{r day2exp10,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "10", "D2", 22)
```
### Day 6 
```{r day6exp10,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "10", "D6", 22)
```
:::
## EXP0012
::: {.panel-tabset}
### Day 2
```{r day2exp12,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "12", "D2", 22)
```
### Day 6 
```{r day6exp12,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "12", "D6", 22)
```
:::
## EXP0019
::: {.panel-tabset}
### Day 2
```{r day2exp19,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "19", "D2", 22)
```
:::
## EXP0020
::: {.panel-tabset}
### Day 2
```{r day2exp20,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "20", "D2", 22)
```
### Day 6 
```{r day6exp20,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "20", "D6", 22)
```
:::
## EXP0024
::: {.panel-tabset}
### Day 2
```{r day2exp24,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "24", "D2", 22)
```
:::
## EXP0025
::: {.panel-tabset}
### Day 6 
```{r day6exp25,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "25", "D6", 22)
```
:::
## EXP0026
::: {.panel-tabset}
### Day 2
```{r day2exp26,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "EXP0026", "D2", 22)
```
### Day 6 
```{r day6exp26,fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "EXP0026", "D6", 22)
```
:::
## EXP0027
::: {.panel-tabset}
### Day 2 
```{r fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "EXP0027", "D2", 22)
```
### Day 6 
```{r fig.height=6, fig.width=14, message=FALSE, warning=FALSE}
create_boxplot(control_data_long, "EXP0027", "D6", 22)
```
:::
::::
:::::
# DATA
## Get LogFoldChange
### Statistics
```{r, message=FALSE, warning=FALSE}
control_cols <- grep("^ControlAN[0-9]+$", names(raw_data), value = TRUE)

raw_data$mean_control <- rowMeans(raw_data[control_cols], na.rm = TRUE)

raw_data$logfold <- raw_data$Cyto_Value / raw_data$mean_control

estadisticos2 <- raw_data %>%
  group_by(Experiment, Strain, Day, Cell, Cell_Type) %>%
  summarise(
    N = n(),
    mean = mean(logfold, na.rm = TRUE),
    median = median(logfold, na.rm = TRUE),
    min = min(logfold, na.rm = TRUE),
    max = max(logfold, na.rm = TRUE),
    sd = sd(logfold, na.rm = TRUE)
  )
datatable(estadisticos2)

raw_data$ControlAN1 <- NULL
raw_data$ControlAN2 <- NULL
raw_data$ControlAN3 <- NULL
raw_data$ControlAN4 <- NULL
raw_data$ControlAN5 <- NULL
raw_data$ControlAN6 <- NULL
raw_data$ControlAN7 <- NULL
raw_data$ControlAN8 <- NULL
raw_data$ControlAN1_ID <- NULL
raw_data$ControlAN2_ID <- NULL
raw_data$ControlAN3_ID <- NULL
raw_data$ControlAN4_ID <- NULL
raw_data$ControlAN5_ID <- NULL
raw_data$ControlAN6_ID <- NULL
raw_data$ControlAN7_ID <- NULL
raw_data$ControlAN8_ID <- NULL
raw_data$Cyto_Value <- NULL
raw_data$Mean_Control <- NULL
raw_data$mean_control <- NULL
```

### Normality Test
::::: {.panel-tabset}
# Shapiro-Wilk Test

```{r}
shapiro_original <- shapiro.test(raw_data$logfold)
print(shapiro_original)
```
# Histogram
```{r}
p1 <- ggplot(raw_data, aes(x = logfold)) +
    geom_histogram(bins = 30, fill = "blue", color = "black") +
    theme_minimal() +
    labs(title = "Histogram logfold", x = "logfold", y = "Frequency")
print(p1)
```

# Q-Q Plot
```{r}
qqnorm(raw_data$logfold)
qqline(raw_data$logfold, col = "red")
```
:::::
### Visualization of LogFoldChange
::::: {.panel-tabset}
# Split by Day
:::: {.panel-tabset}
## Day 2
```{r fig.height=6, fig.width=14, warning=FALSE}
my_comparisons <- list( c("A4", "L5"),c("L5","L6"),c("A1","A4"),c("L6","A4"),c("L5","A1"),c("L6","A1"))
# Calcular el número de observaciones por grupo y encontrar el máximo valor de Value para cada grupo
filter_Day2 <- filter(raw_data, Day == "D2")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')

boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, color = Strain)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(shape = Experiment, fill = Strain), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +
  mycolorsTB::scale_fill_mycolors() +
  theme_bw() +
  labs(y = "LogFoldChante", x = "Strain", title = "Day 2") +
  scale_shape_manual(values = c(21, 24,25,22,21,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.2)),
        plot.title = element_text(size = rel(1.8)),
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05),
            position = position_dodge(width = 0.75),
            size = 3, vjust = 0) + stat_compare_means(aes(group = Strain,label = after_stat(p.signif)),comparisons = my_comparisons, method="wilcox.test")
boxplotD2
```
## Day 6
```{r fig.height=6, fig.width=14, warning=FALSE}
filter_Day2 <- filter(raw_data, Day == "D6")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')

boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, color = Strain)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(shape = Experiment, fill = Strain), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +
  mycolorsTB::scale_fill_mycolors() +
  theme_bw() +
  labs(y = "LogFoldChante", x = "Strain", title = "Day 6") +
  scale_shape_manual(values = c(21, 24,25,22,21,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)+ stat_compare_means(aes(group = Strain,label = after_stat(p.signif)),comparisons = my_comparisons, method="wilcox.test")

boxplotD2
```
::::
# Split by Experiment
:::: {.panel-tabset}
## EXP0026
::: {.panel-tabset}
### Day 2
```{r fig.height=6, fig.width=14, warning=FALSE}
# Calcular el número de observaciones por grupo y encontrar el máximo valor de Value para cada grupo
filter_Day2 <- filter(raw_data, Day == "D2", Experiment == "EXP0026")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')

# Crear el gráfico boxplot
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, color = Strain)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(shape = Experiment, fill = Strain), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +
  mycolorsTB::scale_fill_mycolors() +
  theme_bw() +
  labs(y = "LogFoldChante", x = "Strain", title = "Day 2") +
  scale_shape_manual(values = c(21, 24,25,22,21,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)+ stat_compare_means(aes(group = Strain,label = after_stat(p.signif)),comparisons = my_comparisons, method="wilcox.test")

boxplotD2
```
### Day 6
```{r fig.height=6, fig.width=14, warning=FALSE}
# Calcular el número de observaciones por grupo y encontrar el máximo valor de Value para cada grupo
filter_Day2 <- filter(raw_data, Day == "D6", Experiment == "EXP0026")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')

# Crear el gráfico boxplot
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, color = Strain)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(shape = Experiment, fill = Strain), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +
  mycolorsTB::scale_fill_mycolors() +
  theme_bw() +
  labs(y = "LogFoldChante", x = "Strain", title = "Day 2") +
  scale_shape_manual(values = c(21, 24,25,22,21,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)+ stat_compare_means(aes(group = Strain,label = after_stat(p.signif)),comparisons = my_comparisons, method="wilcox.test")

boxplotD2
```
:::
## EXP0027
::: {.panel-tabset}
### Day 2
```{r fig.height=6, fig.width=14, warning=FALSE}
# Calcular el número de observaciones por grupo y encontrar el máximo valor de Value para cada grupo
filter_Day2 <- filter(raw_data, Day == "D2", Experiment == "EXP0027")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')

# Crear el gráfico boxplot
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, color = Strain)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(shape = Experiment, fill = Strain), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +
  mycolorsTB::scale_fill_mycolors() +
  theme_bw() +
  labs(y = "LogFoldChante", x = "Strain", title = "Day 2") +
  scale_shape_manual(values = c(21, 24,25,22,21,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)+ stat_compare_means(aes(group = Strain,label = after_stat(p.signif)),comparisons = my_comparisons, method="wilcox.test")

boxplotD2
```
### Day 6
```{r fig.height=6, fig.width=14, warning=FALSE}
# Calcular el número de observaciones por grupo y encontrar el máximo valor de Value para cada grupo
filter_Day2 <- filter(raw_data, Day == "D6", Experiment == "EXP0027")

conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')

# Crear el gráfico boxplot
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, color = Strain)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(shape = Experiment, fill = Strain), 
              position = position_jitter(width = 0.2), 
              size = 2, 
              alpha = 0.4) +
  facet_wrap(~ Cell + Cell_Type, nrow = 2, scales = "free_y") + 
  mycolorsTB::scale_color_mycolors() +
  mycolorsTB::scale_fill_mycolors() +
  theme_bw() +
  labs(y = "LogFoldChante", x = "Strain", title = "Day 2") +
  scale_shape_manual(values = c(21, 24,25,22,21,13,12,11,10,9,23,1)) +
  theme(axis.title = element_text(size = rel(1.5)),  
        axis.text = element_text(size = rel(1.2)),  
        plot.title = element_text(size = rel(1.8)),  
        strip.text = element_text(size = rel(1.2))) +
  geom_text(data = conteos, aes(label = N, y = max_value * 1.05), 
            position = position_dodge(width = 0.75), 
            size = 3, vjust = 0)+ stat_compare_means(aes(group = Strain,label = after_stat(p.signif)),comparisons = my_comparisons, method="wilcox.test")

boxplotD2
```
:::
::::
# Compare Cell Hosts
:::: {.panel-tabset}
## Split by Day
::: {.panel-tabset}
### Day 2
```{r fig.height=6, fig.width=8, warning=FALSE}
filter_Day2 <- filter(raw_data, Day == "D2")
conteos <- filter_Day2 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')
# Crear el gráfico boxplot con patrones
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, pattern = Cell, fill=Strain, color=Cell)) +
  geom_boxplot_pattern(outlier.shape = NA, pattern_density = 0.05) + geom_point(aes(shape = Cell), size=2, alpha=.5,position = position_jitterdodge()) + 
facet_wrap(~ Cell_Type, nrow = 2, scales = "free_y") +
theme_bw() +
labs(y = "Log-fold Change", x = "Strain", title = "Day 2") +
theme(axis.title = element_text(size = rel(1.5)),
axis.text = element_text(size = rel(1.2)),
plot.title = element_text(size = rel(1.8)),
strip.text = element_text(size = rel(1.2))) +
geom_text(data = conteos, aes(label = N, y = max_value * 1.05),
position = position_dodge(width = 0.75),
size = 3.5, vjust = 0)+mycolorsTB::scale_fill_mycolors()+ scale_color_manual(values=c("#000000", "#b3b1b1"))
boxplotD2+ stat_compare_means(aes(group = Cell), method="wilcox.test", label = "p.signif")
```
### Day 6
```{r fig.height=6, fig.width=8, warning=FALSE}
filter_Day6 <- filter(raw_data, Day == "D6")
conteos <- filter_Day6 %>%
  group_by(Strain, Cell, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')
# Crear el gráfico boxplot con patrones
boxplotD6 <- ggplot(filter_Day6, aes(x = Strain, y = logfold, pattern = Cell, fill=Strain, color=Cell)) +
  geom_boxplot_pattern(outlier.shape = NA, pattern_density = 0.05) + geom_point(aes(shape = Cell), size=2, alpha=.5,position = position_jitterdodge()) + 
facet_wrap(~ Cell_Type, nrow = 2, scales = "free_y") +
theme_bw() +
labs(y = "Log-fold Change", x = "Strain", title = "Day 6") +
theme(axis.title = element_text(size = rel(1.5)),
axis.text = element_text(size = rel(1.2)),
plot.title = element_text(size = rel(1.8)),
strip.text = element_text(size = rel(1.2))) +
geom_text(data = conteos, aes(label = N, y = max_value * 1.05),
position = position_dodge(width = 0.75),
size = 3.5, vjust = 0)+mycolorsTB::scale_fill_mycolors()+ scale_color_manual(values=c("#000000", "#b3b1b1"))
boxplotD6+ stat_compare_means(aes(group = Cell), method="wilcox.test", label = "p.signif")
```
:::
## Split by Cell check time progression
::: {.panel-tabset}
## THP-1
```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
filter_Day2 <- filter(raw_data, Cell == "THP1")
conteos <- filter_Day2 %>%
  group_by(Strain, Day, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')
# Crear el gráfico boxplot con patrones
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, pattern = Day, fill=Strain, color=Day)) +
  geom_boxplot_pattern(outlier.shape = NA, pattern_density = 0.05) + geom_point(aes(shape = Day), size=2, alpha=.5,position = position_jitterdodge()) + theme_bw()+
facet_wrap(~ Cell_Type, nrow = 2, scales = "free_y") +
labs(y = "Log-fold Change", x = "", title = "THP-1") +
theme(axis.title = element_text(size = rel(1.5)),
axis.text = element_text(size = rel(1.2)),
plot.title = element_text(size = rel(1.8)),
strip.text = element_text(size = rel(1.2))) +
geom_text(data = conteos, aes(label = N, y = max_value * 1.05),
position = position_dodge(width = 0.75),
size = 3.5, vjust = 0)+mycolorsTB::scale_fill_mycolors()+ scale_color_manual(values=c("#000000", "#b3b1b1"))  
boxplotD2+ stat_compare_means(aes(group = Day), method="wilcox.test", label = "p.signif") + labs(y = "Log-fold Change", x = "", title = "THP-1") 

```
## BoMac
```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
filter_Day2 <- filter(raw_data, Cell == "BoMac")
conteos <- filter_Day2 %>%
  group_by(Strain, Day, Cell_Type) %>%
  summarize(N = n(), max_value = max(logfold, na.rm = TRUE), .groups = 'drop')
# Crear el gráfico boxplot con patrones
boxplotD2 <- ggplot(filter_Day2, aes(x = Strain, y = logfold, pattern = Day, fill=Strain, color=Day)) +
  geom_boxplot_pattern(outlier.shape = NA, pattern_density = 0.05) + geom_point(aes(shape = Day), size=2, alpha=.5,position = position_jitterdodge()) +theme_bw()+ 
facet_wrap(~ Cell_Type, nrow = 2, scales = "free_y") +
labs(y = "Log-fold Change", x = "", title = "BoMac")  +
theme(axis.title = element_text(size = rel(1.5)),
axis.text = element_text(size = rel(1.2)),
plot.title = element_text(size = rel(1.8)),
strip.text = element_text(size = rel(1.2)))+
geom_text(data = conteos, aes(label = N, y = max_value * 1.05),
position = position_dodge(width = 0.75),
size = 3.5, vjust = 0)+mycolorsTB::scale_fill_mycolors()+ scale_color_manual(values=c("#000000", "#b3b1b1"))
boxplotD2+ stat_compare_means(aes(group = Day), method="wilcox.test", label = "p.signif")
```
:::
::::
:::::